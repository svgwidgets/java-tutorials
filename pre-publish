# ── Pre-release publish on MR branches ──────────────────
publish-prerelease:
  stage: version  # same stage as your semantic-tag job
  image: node:25
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual  # click to publish — avoids spamming registry
  before_script:
    - npm ci --cache .npm --prefer-offline
    # Configure npm auth for your self-managed GitLab
    - |
      echo "@my-group:registry=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/" > .npmrc
      echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
  script:
    # 1. Figure out what version semantic-release WOULD create
    - NEXT_VERSION=$(npx semantic-release --dry-run 2>&1 | grep -oP 'next release version is \K[0-9]+\.[0-9]+\.[0-9]+' || echo "")
    - |
      if [ -z "$NEXT_VERSION" ]; then
        echo "semantic-release found no releasable commits, using current version"
        NEXT_VERSION=$(node -p "require('./package.json').version" | sed 's/-.*//') 
      fi
    # 2. Build prerelease tag:  1.3.0-beta.mr-42.3  (MR number + pipeline IID for uniqueness)
    - PRE_VERSION="${NEXT_VERSION}-beta.mr-${CI_MERGE_REQUEST_IID}.${CI_PIPELINE_IID}"
    - echo "Publishing prerelease version ${PRE_VERSION}"
    # 3. Stamp version into package.json (no git commit, just local)
    - npm version "${PRE_VERSION}" --no-git-tag-version
    # 4. Build
    - npm run build
    # 5. Publish with beta dist-tag so it doesn't become "latest"
    - npm publish --tag beta
    - echo "✅ Install with → npm install @my-group/pid-components@${PRE_VERSION}"
  interruptible: true
