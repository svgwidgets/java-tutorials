# Test Bench Control & Monitoring System

A web application for designing P&ID diagrams, monitoring physical test benches in real time, commanding actuators, running test sequences, and enforcing safety redlines — built for large curved operator stations.

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   P&ID       │    │   Live       │    │   Sequence   │    │   Redline    │
│   Designer   │    │   Dashboard  │    │   Runner     │    │   Engine     │
│   (SVG/Vue)  │    │   (Panels)   │    │   (Steps)    │    │   (Safety)   │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │                   │
       └───────────────────┴───────────────────┴───────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │     Python Backend (FastAPI) │
                    │     REST + WebSocket + gRPC  │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │  PLC Gateway (Industrial SE) │
                    │  Beckhoff ADS via gRPC       │
                    └──────────────────────────────┘
```

---

## Table of Contents

- [Overview](#overview)
- [P&ID Component Library](#pid-component-library)
- [P&ID Designer](#pid-designer)
- [System Architecture](#system-architecture)
- [Tech Stack](#tech-stack)
- [Getting Started](#getting-started)
- [Project Structure](#project-structure)
- [Component Reference](#component-reference)
- [API Summary](#api-summary)
- [Safety Model](#safety-model)
- [Development](#development)
- [Documentation](#documentation)

---

## Overview

This monorepo contains three tightly coupled systems:

| System | Purpose | Status |
|--------|---------|--------|
| **P&ID Component Library** | Reusable SVG components for valves, pumps, tanks, sensors, pipes | ✅ Production-ready |
| **P&ID Designer** | Drag-and-drop editor for building and viewing P&ID diagrams | ✅ Architecture + skeleton |
| **Test Bench Backend** | Command execution, sequence engine, redline safety, data recording | ✅ Architecture designed |

The system is purpose-built for physical test bench operations where operators need to visualize process flow, send commands to actuators, run automated test sequences, and have continuous safety monitoring with automatic abort capability.

---

## P&ID Component Library

The library provides **dumb, protocol-agnostic** Vue 3 SVG components. They receive simple props and emit events. They know nothing about data sources, protocols, or state management.

### Components

| Component | Type | Props | Description |
|-----------|------|-------|-------------|
| `ManualValve` | Digital | `state`, `alarm`, `label` | Two-state valve (open/closed) with alarm indication |
| `GeneralPump` | Digital | `state`, `alarm`, `label` | Pump with rotation animation when running |
| `VerticalTank` | Analog | `level`, `alarm`, `label`, `width`, `height` | Tank with animated fill level (0–100%) |
| `AnalogDisplay` | Analog | `value`, `units`, `alarm`, `tag`, `label` | Rounded rectangle sensor display with alarm stripe |
| `ConnectionPipe` | Connector | `startPosition`, `endPosition`, `waypoints`, `flowing` | Multi-segment pipe with flow animation |
| `PortIndicator` | Common | `ports`, `show`, `highlightedPortId` | Renders port dots on components for the editor |
| `ComponentLabel` | Common | `text`, `x`, `y` | Consistent label rendering across components |

### Usage

```vue
<template>
  <svg width="800" height="600">
    <g transform="translate(100, 100)">
      <ManualValve :state="valveState" :alarm="valveAlarm" label="V-001" />
    </g>
    <g transform="translate(300, 80)">
      <GeneralPump :state="pumpState" label="P-001" />
    </g>
    <g transform="translate(500, 50)">
      <VerticalTank :level="tankLevel" label="T-001" />
    </g>
    <ConnectionPipe
      :start-position="{ x: 140, y: 112 }"
      :end-position="{ x: 300, y: 100 }"
      :flowing="pumpState === 'running'"
    />
  </svg>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { ManualValve, GeneralPump, VerticalTank, ConnectionPipe } from '@/lib'

const valveState = ref<'open' | 'closed'>('closed')
const valveAlarm = ref<'none' | 'warning' | 'alarm'>('none')
const pumpState = ref<'running' | 'stopped'>('stopped')
const tankLevel = ref(65)
</script>
```

### Design Principles

**Dumb components.** The library does not fetch data, manage state, or connect to protocols. Your application does that. The same `<ManualValve>` works whether the data comes from a WebSocket, gRPC, Modbus, OpenC3, or a local mock.

**Port-based connections.** Each component exposes ports (connection points) via `defineExpose({ ports })`. The designer reads these at runtime through template refs — no hardcoded port registries, no sync issues.

**Pure SVG.** All components render as `<g>`, `<polygon>`, `<circle>`, `<rect>`, `<path>` — native SVG elements with `vector-effect="non-scaling-stroke"`. No Canvas 2D, no WebGL. Vue reactivity drives all visual updates.

### Prop Interfaces

```typescript
// Digital components (ManualValve, GeneralPump)
interface DigitalProps {
  state: 'open' | 'closed' | 'running' | 'stopped'
  alarm?: 'none' | 'warning' | 'alarm'
  label?: string
  showLabel?: boolean
  showPorts?: boolean
}

// Analog components (VerticalTank, AnalogDisplay)
interface AnalogProps {
  value?: number
  level?: number          // Tank-specific (0-100%)
  units?: string          // "PSI", "°C", "L"
  alarm?: 'none' | 'warning' | 'alarm'
  tag?: string            // Sensor tag prefix ("PT", "TT")
  label?: string
}

// Pipe
interface PipeProps {
  startPosition: { x: number; y: number }
  endPosition: { x: number; y: number }
  waypoints?: Array<{ x: number; y: number }>
  flowing?: boolean
  direction?: 'forward' | 'reverse'
  strokeWidth?: number
  flowColor?: string
}
```

---

## P&ID Designer

An interactive editor for placing components on a canvas, connecting them with pipes, and exporting/importing diagrams as JSON. Built on top of the component library.

### Features

- Drag components from a categorized palette onto an SVG canvas
- Pan (shift+drag or middle-click) and zoom (scroll wheel)
- Connect components by clicking ports — orthogonal pipe routing
- Select, move, and delete nodes and edges
- 8-port junction nodes for pipe branching
- Export/import diagrams as versioned JSON (schema v1)
- Edit mode (design) and Run mode (live data, no editing)
- Keyboard shortcuts (Delete to remove, Escape to cancel drawing)

### Architecture

```
src/
├── domain/          Pure TypeScript models (zero Vue imports)
│   ├── models.ts    DiagramNode, DiagramEdge, Diagram, Point, etc.
│   ├── defaults.ts  Node type registry, factories, label generators
│   ├── schema.ts    JSON validation for import/export
│   └── geometry.ts  Distance, snap, orthogonal routing, viewport culling
│
├── stores/
│   └── useDiagramStore.ts   Single Pinia store (nodes, edges, viewport, selection, drawing)
│
├── composables/     Interaction logic (no rendering)
│   ├── useCanvas.ts          Pan, zoom, coordinate transforms, ResizeObserver
│   ├── useNodeDrag.ts        Drag-to-reposition with route recomputation on drop
│   ├── usePipeDraw.ts        Port-to-port connection drawing (ortho snap)
│   ├── useOrthoRouter.ts     Component ref registry, port world positions, route computation
│   ├── useSerializer.ts      JSON export/import with schema validation
│   └── usePaletteDrop.ts     HTML5 drag-and-drop from palette to canvas
│
├── components/
│   ├── canvas/      DiagramCanvas, NodeRenderer, EdgeRenderer, JunctionNode, CanvasGrid, etc.
│   ├── layout/      AppToolbar, AppStatusBar, PalettePanel
│   └── palette/     PaletteItem (draggable)
│
├── pages/
│   ├── DesignerPage.vue   Main editor (palette + canvas + toolbar)
│   └── ExamplesPage.vue   Pre-built demo diagrams
│
└── lib/             P&ID Component Library (symlink or copy)
```

### Diagram JSON Format

```json
{
  "schemaVersion": 1,
  "id": "abc-123",
  "name": "Water Treatment Loop",
  "nodes": [
    {
      "id": "node-1",
      "typeId": "manual-valve",
      "position": { "x": 200, "y": 150 },
      "rotation": 0,
      "label": "V-001",
      "dimensions": { "width": 40, "height": 24 },
      "props": { "state": "closed", "alarm": "none" }
    }
  ],
  "edges": [
    {
      "id": "edge-1",
      "from": { "nodeId": "node-1", "portId": "outlet" },
      "to": { "nodeId": "node-2", "portId": "inlet" },
      "waypoints": [{ "x": 240, "y": 162 }, { "x": 300, "y": 162 }],
      "props": { "flowing": false, "direction": "forward" }
    }
  ],
  "viewport": { "panX": 0, "panY": 0, "zoom": 1 }
}
```

---

## System Architecture

The full test bench system adds a Python backend, safety engine, and PLC integration on top of the frontend.

### Layers

| Layer | Technology | Responsibility |
|-------|-----------|----------------|
| Frontend | Vue 3 + TypeScript + Vuetify | P&ID visualization, dashboards, command UI, sequence runner |
| Backend | Python + FastAPI | REST API, WebSocket streaming, sequence engine, redline evaluation, recording |
| PLC Gateway | .NET/C# (Industrial SE) | gRPC server wrapping Beckhoff ADS driver |
| Storage | PostgreSQL + TimescaleDB + MinIO | Config/auth, time-series, object archives |

### Backend Services

| Service | Purpose |
|---------|---------|
| `auth/` | JWT authentication, role-based access (admin, operator, viewer) |
| `bench/` | Bench configuration CRUD with versioning |
| `diagram/` | P&ID diagram storage and export |
| `commands/` | Two-step command protocol (prepare → send → ack) with timeout tracking |
| `sequences/` | Test sequence CRUD, version control, file upload |
| `sequences/engine.py` | Async state machine executing sequence steps |
| `sequences/routines.py` | Built-in Fill, Drain, Chilldown routines |
| `redlines/` | Safety threshold config and continuous evaluation engine |
| `live/` | gRPC subscription → WebSocket fan-out with per-client throttling |
| `recorder/` | TimescaleDB batch inserts, configurable frequency |
| `journal/` | Append-only audit log (DEBUG/INFO/WARN/ERROR) |
| `plc/` | gRPC client with auto-reconnect |

### Full architecture details: [`docs/TEST_BENCH_SYSTEM_ARCHITECTURE.md`](docs/TEST_BENCH_SYSTEM_ARCHITECTURE.md)

---

## Tech Stack

### Frontend

| Library | Version | Purpose |
|---------|---------|---------|
| Vue | 3.4+ | Composition API framework |
| TypeScript | 5.4+ | Type safety |
| Vuetify | 3.5+ | UI component library (dark theme) |
| Pinia | 2.2+ | State management |
| Vue Router | 4.3+ | Page routing |
| Vite | 5.4+ | Build tool |
| uPlot | — | High-frequency charting (100k+ points) |
| vue-grid-layout | — | Configurable dashboard panels |

### Backend

| Library | Purpose |
|---------|---------|
| FastAPI + Uvicorn | Async web framework + ASGI server |
| SQLAlchemy (async) + asyncpg | ORM + Postgres driver |
| Alembic | Database migrations |
| grpcio | PLC Gateway gRPC client |
| structlog | Structured JSON logging |
| Pydantic | Request/response validation |
| python-jose | JWT tokens |
| orjson | Fast JSON serialization |
| prometheus-fastapi-instrumentator | Metrics |
| OpenTelemetry | Distributed tracing |

### Infrastructure

| Component | Technology |
|-----------|-----------|
| Relational DB | PostgreSQL 16 |
| Time-series | TimescaleDB (Postgres extension) |
| Object storage | MinIO (S3-compatible) |
| Observability | Grafana + Prometheus + Jaeger |

---

## Getting Started

### Prerequisites

- Node.js 20+
- Python 3.12+
- Docker + Docker Compose
- `uv` (Python package manager, recommended)

### Local Development

```bash
# 1. Clone
git clone <repo-url>
cd test-bench

# 2. Start infrastructure (Postgres + TimescaleDB + MinIO)
docker compose -f docker/docker-compose.yml up -d db minio

# 3. Backend
cd backend
uv sync
uv run alembic upgrade head        # Run migrations
uv run uvicorn app.main:app --reload --port 8000

# 4. Frontend (new terminal)
cd frontend
npm install
npm run dev                         # http://localhost:5173
```

### Quick Docker (everything)

```bash
docker compose -f docker/docker-compose.yml up
# Frontend: http://localhost:5173
# Backend API: http://localhost:8000
# API Docs: http://localhost:8000/docs
# MinIO Console: http://localhost:9001
```

---

## Project Structure

```
test-bench/
├── frontend/                      Vue 3 + TypeScript + Vuetify
│   ├── src/
│   │   ├── lib/                   P&ID Component Library
│   │   │   ├── components/PID/    ManualValve, GeneralPump, VerticalTank, AnalogDisplay, ConnectionPipe
│   │   │   ├── components/common/ PortIndicator, ComponentLabel
│   │   │   ├── composables/       usePortEvents
│   │   │   ├── types/
│   │   │   ├── constants/
│   │   │   └── utils/
│   │   │
│   │   ├── domain/                Pure TS models (shared with designer)
│   │   ├── stores/                Pinia (auth, bench, liveData, commands, sequences, redlines, runs, diagram)
│   │   ├── composables/           Canvas, drag, draw, routing, serialization, connection health
│   │   ├── api/                   HTTP + WebSocket transport
│   │   ├── components/
│   │   │   ├── canvas/            P&ID renderer/editor
│   │   │   ├── layout/            App shell, toolbar, palette
│   │   │   ├── commands/          Two-step command UI
│   │   │   ├── sequences/         Sequence editor, progress, graph
│   │   │   ├── redlines/          Redline config + go/no-go panel
│   │   │   ├── dashboard/         Configurable grid, value cards, live charts
│   │   │   └── journal/           Log viewer + filters
│   │   │
│   │   ├── pages/                 Designer, Dashboard, Sequences, Redlines, Journal, Admin, Archives
│   │   └── router/
│   │
│   └── tests/
│
├── backend/                       Python (FastAPI)
│   ├── app/
│   │   ├── auth/                  JWT + RBAC
│   │   ├── bench/                 Versioned bench config
│   │   ├── diagram/               P&ID JSON storage
│   │   ├── commands/              Two-step command protocol
│   │   ├── sequences/             Sequence engine + routines
│   │   ├── redlines/              Safety threshold evaluation
│   │   ├── live/                  WebSocket streaming + throttling
│   │   ├── recorder/              TimescaleDB recording + archiver
│   │   ├── journal/               Audit log
│   │   ├── plc/                   gRPC client + health
│   │   ├── events/                In-process event bus
│   │   └── db/                    SQLAlchemy + Alembic
│   │
│   └── tests/
│
├── proto/                         Shared gRPC definitions
│   └── plc_gateway.proto
│
├── docker/
│   ├── Dockerfile.frontend
│   ├── Dockerfile.backend
│   └── docker-compose.yml
│
├── docs/
│   ├── TEST_BENCH_SYSTEM_ARCHITECTURE.md    Full system architecture
│   ├── PID_DESIGNER_ARCHITECTURE.md         Designer POC architecture
│   └── PID_Component_Library_Complete_Documentation.md
│
└── README.md                      This file
```

---

## Component Reference

### ManualValve

Two-triangle bowtie shape representing a manual gate valve.

```vue
<ManualValve state="open" alarm="none" label="V-001" :show-ports="true" />
```

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `state` | `'open' \| 'closed'` | required | Valve position |
| `alarm` | `'none' \| 'warning' \| 'alarm'` | `'none'` | Alarm state (changes color) |
| `label` | `string` | — | Tag displayed above component |
| `showLabel` | `boolean` | `true` | Toggle label visibility |
| `showPorts` | `boolean` | `false` | Show port indicators (editor mode) |

**Ports:** `inlet` (left), `outlet` (right)

### GeneralPump

Circular pump with impeller rotation animation when running.

```vue
<GeneralPump state="running" label="P-001" />
```

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `state` | `'running' \| 'stopped'` | required | Pump state |
| `alarm` | `'none' \| 'warning' \| 'alarm'` | `'none'` | Alarm state |

**Ports:** `inlet` (left), `outlet` (right)

### VerticalTank

Rectangular tank with animated liquid fill level.

```vue
<VerticalTank :level="75" alarm="warning" label="T-001" :width="100" :height="180" />
```

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `level` | `number` | `0` | Fill percentage (0–100) |
| `alarm` | `'none' \| 'warning' \| 'alarm'` | `'none'` | Alarm state |
| `width` | `number` | `100` | Tank width in SVG units |
| `height` | `number` | `180` | Tank height in SVG units |

**Ports:** `top` (center top), `bottom` (center bottom), `left` (mid-left), `right` (mid-right)

### AnalogDisplay

Rounded rectangle showing a numeric value with units, tag prefix, and alarm stripe.

```vue
<AnalogDisplay :value="125.5" units="PSI" tag="PT" alarm="none" label="PT-001" />
```

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `value` | `number` | `0` | Displayed value |
| `units` | `string` | — | Unit label ("PSI", "°C") |
| `tag` | `string` | — | Instrument tag prefix ("PT", "TT") |
| `alarm` | `'none' \| 'warning' \| 'alarm'` | `'none'` | Alarm state (left stripe color) |

**Ports:** `top`, `bottom`, `left`, `right`

### ConnectionPipe

Multi-segment pipe with animated flow dots.

```vue
<ConnectionPipe
  :start-position="{ x: 100, y: 200 }"
  :end-position="{ x: 400, y: 200 }"
  :waypoints="[{ x: 200, y: 200 }, { x: 200, y: 300 }, { x: 400, y: 300 }]"
  :flowing="true"
/>
```

---

## API Summary

| Protocol | Endpoint | Purpose |
|----------|----------|---------|
| REST | `POST /api/auth/login` | JWT authentication |
| REST | `GET/POST /api/benches` | Bench configuration (versioned) |
| REST | `GET/POST /api/diagrams` | P&ID diagram CRUD |
| REST | `POST /api/commands/prepare` | Step 1: prepare command |
| REST | `POST /api/commands/{id}/send` | Step 2: confirm and send |
| REST | `POST /api/runs/start` | Start a test sequence run |
| REST | `POST /api/runs/{id}/abort` | Abort (triggers safe-abort) |
| REST | `GET/POST /api/redlines` | Safety threshold config |
| REST | `GET /api/journal` | Paginated audit log |
| WebSocket | `/ws/live` | Live sensor data, command acks, redline events, sequence progress |
| gRPC | `PLCGateway.SubscribeTags` | PLC tag subscriptions (from Industrial SE) |
| gRPC | `PLCGateway.WriteTag` | PLC actuator commands |

Full OpenAPI docs available at `http://localhost:8000/docs` when the backend is running.

---

## Safety Model

### ARMED Mode

The system has a global ARMED state that gates unsafe operations during test runs. When a run is ARMED or RUNNING, bench config changes, active redline modifications, and starting additional sequences are all blocked at the backend middleware level — not per-endpoint, not frontend-only.

### Two-Step Commands

Every actuator command follows: **Prepare** (validate, store) → **Operator confirms** → **Send** (gRPC to PLC) → **Ack** (PLC read-back verification). Commands track through states: `prepared → sent → acknowledged → applied` (or `failed` / `timeout`).

### Redlines

Three evaluation modes: **Go/No-Go** (checked once before run starts), **Continuous** (every data cycle during a run, triggers safe-abort), **Always-Active / Yellowlines** (evaluated at all times, warn only). The redline engine subscribes to live sensor data on the internal event bus and publishes trigger events that the sequence engine consumes.

### Safe Abort

When a redline triggers or the operator aborts, the system executes a **configurable safe-abort sequence** defined per bench (not hardcoded). This ensures orderly shutdown appropriate to the specific hardware (e.g., vent before closing cryogenic valves). Hard safety (emergency stop, PLC disconnect) is handled autonomously by the PLC's own safety program.

---

## Development

### Frontend

```bash
cd frontend
npm run dev           # Dev server with hot reload
npm run build         # Production build
npm run lint          # ESLint
npm run type-check    # vue-tsc
npm run test:unit     # Vitest
```

### Backend

```bash
cd backend
uv run uvicorn app.main:app --reload    # Dev server
uv run ruff check .                      # Lint
uv run ruff format .                     # Format
uv run mypy app/                         # Type check
uv run pytest --cov=app                  # Test with coverage
uv run alembic revision --autogenerate -m "description"  # New migration
uv run alembic upgrade head              # Apply migrations
```

### CI

GitHub Actions runs on every PR: lint + type-check + test for both frontend and backend, plus proto compilation verification.

---

## Documentation

| Document | Contents |
|----------|----------|
| [`docs/TEST_BENCH_SYSTEM_ARCHITECTURE.md`](docs/TEST_BENCH_SYSTEM_ARCHITECTURE.md) | Full system architecture: backend decomposition, data architecture, API design, domain models, safety patterns, non-functional requirements, decision rationale |
| [`docs/PID_DESIGNER_ARCHITECTURE.md`](docs/PID_DESIGNER_ARCHITECTURE.md) | Designer POC: folder structure, data models, Pinia store, composables, component templates, performance strategy |
| [`docs/PID_Component_Library_Complete_Documentation.md`](docs/PID_Component_Library_Complete_Documentation.md) | Original library documentation: I/O abstraction, visual system, animation system, component API |

---

## License

Internal / Proprietary
